on:
  push:
  workflow_dispatch:

env:
  # Set the DOTNET_SKIP_FIRST_TIME_EXPERIENCE environment variable to stop wasting time caching packages
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  # Disable sending usage data to Microsoft
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  push:
    strategy:
      fail-fast: false
      matrix:
        dotnet-version: [1.1.x,2.0.x,2.1.x,3.0.x,3.1.x]
        handler: [true]
        os: [ubuntu-latest]
        try: [0,1,2,3]
    
    runs-on: macos-latest

    env:
      SOURCE: "https://nuget.pkg.github.com/${{github.repository_owner}}/index.json"

    steps:
    - uses: actions/checkout@v2

    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ matrix.dotnet-version }} # SDK Version to use.
        source-url: ${{ env.SOURCE }}
      env:
        NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
     
    - run: |
        dotnet new console
        dotnet pack -p:RepositoryUrl=${{ github.server_url }}/${{ github.repository }} -p:Version=1.0.0-g${{ github.sha }}-${{ strategy.job-index }}
       
    - name: Publish package
      run: |
        dotnet nuget push bin/Debug/*.nupkg -s ${{ env.SOURCE }}
      env:
        DOTNET_SYSTEM_NET_HTTP_USESOCKETSHTTPHANDLER: ${{ matrix.handler }}
